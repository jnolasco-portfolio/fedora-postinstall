---
# Read: https://sysguides.com/install-kvm-on-linux
- name: Install and Configure KVM
  hosts: localhost
  become: true
  tasks:
    - name: Include user variables
      include_vars:
        file: ../vars/application-versions.yaml

    - name: Install virtualization packages
      dnf:
        name: "@virtualization"
        state: present

    - name: Add user to libvirt and kvm groups
      user:
        name: "{{ usuario_sistema }}"
        groups: libvirt,kvm
        append: yes

    - name: Enable and start all modular libvirt daemon sockets
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      with_items:
        - virtinterfaced.socket
        - virtnetworkd.socket
        - virtnodedevd.socket
        - virtnwfilterd.socket
        - virtqemud.socket
        - virtsecretd.socket
        - virtstoraged.socket

    - name: Start and autostart the default libvirt network
      community.libvirt.virt_net:
        name: default
        state: active
        autostart: yes

    - name: Add VirtIO drivers repository for Windows guests
      ansible.builtin.get_url:
        url: "https://fedorapeople.org/groups/virt/virtio-win/virtio-win.repo"
        dest: "/etc/yum.repos.d/virtio-win.repo"
        mode: "0644"

    - name: Install VirtIO drivers for Windows guests
      ansible.builtin.dnf:
        name: virtio-win
        state: present
